apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - role.yaml
  - leader_election_role.yaml
  - role_binding.yaml
  - leader_election_role_binding.yaml

patches:
  # Remove unwanted rules from manager-role
  # Indices are auto-generated by 'make update-rbac-indices'
  - target:
      kind: ClusterRole
      name: manager-role
    patch: |-
      # Remove in reverse order (highest index first) to avoid shifting
      # Remove: provisioning.dpu.nvidia.com (dpuclusters/finalizers)
      - op: remove
        path: /rules/16
      # Remove: provisioning.dpu.nvidia.com (dpuclusters/status)
      - op: remove
        path: /rules/15
      # Remove: provisioning.dpu.nvidia.com (dpuclusters)
      - op: remove
        path: /rules/14
      # Remove: operator.dpu.nvidia.com (dpfoperatorconfigs)
      - op: remove
        path: /rules/13
      # Remove: cert-manager.io (certificaterequests, certificates, issuers)
      - op: remove
        path: /rules/7
  - target:
      kind: ClusterRole
      name: manager-role
    patch: |-
      - op: replace
        path: /metadata/name
        value: '{{ include "doca-provisioning.fullname" . }}'
      - op: add
        path: /metadata/labels
        value:
          '{{- include "doca-provisioning.labels" . | nindent 4 }}'

  # Convert leader-election Role to ClusterRole and add Helm templates
  - target:
      kind: Role
      name: leader-election-role
    patch: |-
      - op: replace
        path: /kind
        value: ClusterRole
      - op: replace
        path: /metadata/name
        value: '{{ include "doca-provisioning.fullname" . }}-leader-election'
      - op: add
        path: /metadata/labels
        value:
          '{{- include "doca-provisioning.labels" . | nindent 4 }}'

  # Patch manager ClusterRoleBinding
  - target:
      kind: ClusterRoleBinding
      name: manager-rolebinding
    patch: |-
      - op: replace
        path: /metadata/name
        value: '{{ include "doca-provisioning.fullname" . }}'
      - op: add
        path: /metadata/labels
        value:
          '{{- include "doca-provisioning.labels" . | nindent 4 }}'
      - op: replace
        path: /roleRef/name
        value: '{{ include "doca-provisioning.fullname" . }}'
      - op: replace
        path: /subjects/0/name
        value: '{{ include "doca-provisioning.serviceAccountName" . }}'
      - op: replace
        path: /subjects/0/namespace
        value: '{{ .Release.Namespace }}'

  # Convert leader-election RoleBinding to ClusterRoleBinding and patch
  - target:
      kind: RoleBinding
      name: leader-election-rolebinding
    patch: |-
      - op: replace
        path: /kind
        value: ClusterRoleBinding
      - op: replace
        path: /metadata/name
        value: '{{ include "doca-provisioning.fullname" . }}-leader-election'
      - op: add
        path: /metadata/labels
        value:
          '{{- include "doca-provisioning.labels" . | nindent 4 }}'
      - op: replace
        path: /roleRef/kind
        value: ClusterRole
      - op: replace
        path: /roleRef/name
        value: '{{ include "doca-provisioning.fullname" . }}-leader-election'
      - op: replace
        path: /subjects/0/name
        value: '{{ include "doca-provisioning.serviceAccountName" . }}'
      - op: replace
        path: /subjects/0/namespace
        value: '{{ .Release.Namespace }}'
